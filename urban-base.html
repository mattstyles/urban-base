<link rel="import" href="../polymer/polymer.html">

<polymer-element name="urban-base">

    <script charset="utf-8">

            (function( root ) {

                /**
                 * Simplest extend function
                 */
                function extend( base, obj ) {
                    for ( var prop in obj ) {
                        if ( !base.hasOwnProperty( prop ) ) {
                            base[ prop ] = obj[ prop ];
                        }
                    }

                    return base;
                }


                /**
                 * Simple find for checking the listeners array for a listener
                 *
                 * @param listeners {Array} the array to search
                 * @param listener {Function} the handler and event to search for
                 * @returns {Integer} the index of the function within the array or -1 if not found
                 */
                function findListener( listeners, listener ) {
                    var i = listeners.length;
                    while( i-- ) {
                        if ( listeners[ i ].event === listener.event && listeners[ i ].listener === listener.listener ) {
                            return i;
                        }
                    }
                    return -1;
                }


                /**
                 * Returns a list of indices that correspond to a certain event
                 *
                 * @param listeners {Array} the search space
                 * @param event {String} id of string to search for
                 * @returns {Array:Integers} indices of corresponding handlers for events
                 */
                function findEventListeners( listeners, event ) {
                    var i = listeners.length;
                    var output = [];
                    while( i-- ) {
                        if ( listeners[ i ].event === event ) {
                            output.push( i );
                        }
                    }
                    return output;
                }


                Polymer( 'urban-base', {

                    /**
                     * List of attached listeners
                     *
                     * Elements appended to this array should be
                     *   {
                     *     event,    // the event a listener is bound to
                     *     listener, // the unwrapped listener passed to .on
                     *     handler   // the actual handler attached to the event
                     *   }
                     */
                    _listeners: null,


                    /*-----------------------------------------------------------*\
                     *
                     *  Polymer lifecycle events
                     *
                    \*-----------------------------------------------------------*/

                    created: function() {
                        this._listeners = [];
                    },


                    ready: function() {
                        this.bindAll( this );
                    },



                    /*-----------------------------------------------------------*\
                     *
                     *  Helpers
                     *
                    \*-----------------------------------------------------------*/


                    /**
                     * Simple, dirty bindAll implementation
                     *
                     * @param ctx {Object} the context to bind `this` to
                     */
                    bindAll: function( ctx ) {
                        for ( var method in this ) {
                            if ( typeof this[ method ] === 'function' && !this.hasOwnProperty( method ) ) {
                                try {
                                    this[ method ] = this[ method ].bind( ctx );
                                } catch( err ) {
                                    console.log( this.element.name + '::', 'method binding error\n', method, err );
                                }
                            }
                        }
                    },


                    /**
                     * Adds an event listener that will be removed after the first execution
                     *
                     * @param type {String} id of event to listen for
                     * @param data {Anything} _optional_ additional data that is always passed to the callback - takes precedence over data passed along with the firing/triggering of the event
                     * @param cb {Function} the callback to fire when the event is fired
                     * @param ctx {Object} _optional_ the context the callback should be run in, defaults to __this__
                     */
                    once: function( type, data, cb, ctx ) {
                        // Arity
                        if ( typeof data === 'function' ) {
                            this.once( type, null, data, cb );
                            return;
                        }

                        var callback = function( event ) {
                            this.removeEventListener( type, callback );

                            // Append listener data to event.detail
                            if ( typeof data === 'object' ) {
                                event.detail = extend( event.detail, data );
                            } else {
                                event.detail.data = data;
                            }

                            cb.call( ctx || this, event );
                        }.bind( this );

                        this.addEventListener( type, callback );
                    },


                    /**
                     * Semi-alias for addEventListener.
                     * Wraps context to the listening object.
                     * Allows data to be passed by the listener function.
                     */
                    on: function( type, data, cb, ctx ) {
                        // Arity
                        if ( typeof data === 'function' ) {
                            this.on( type, null, data, cb );
                            return;
                        }

                        var callback = function( event ) {
                            // Append listener data to event.detail
                            if ( typeof data === 'object' ) {
                                event.detail = extend( event.detail, data );
                            } else {
                                event.detail.data = data;
                            }

                            cb.call( ctx || this, event );
                        }.bind( this );

                        this._listeners.push({
                            event: type,
                            listener: cb,
                            handler: callback
                        });
                        this.addEventListener( type, callback );
                    },


                    /**
                     * Semi-alias for removeEventListener.
                     * Removes an event listener previously attached using .on
                     */
                    off: function( type, cb ) {
                        // If not cb is supplied then nuke all events for this element
                        if ( !cb ) {
                            console.log( 'not yet implemented, give me a handler to remove' );
                        }

                        var i = findListener( this._listeners, {
                            event: type,
                            listener: cb
                        });

                        // If listener is not found bound to this event then bail
                        if ( i < 0 ) {
                            return;
                        }

                        // Otherwise remove event listener and kill it in the listener array
                        this.removeEventListener( type, this._listeners[ i ].handler );
                        this._listeners.splice( i, 1 );
                    }

                });


            })( this );

    </script>
</polymer-element>
